# Codegen Test Package

This package demonstrates and validates the OpenAPI parser codegen tool.

## Purpose

This is a **test package** that serves two purposes:
1. **Example**: Shows how to extend the Time Series Query OpenAPI spec with custom datasources
2. **Validation**: Tests that the codegen tool correctly transforms parser files

## What's Included

### Extended OpenAPI Specification

[extended-swagger.yaml](./extended-swagger.yaml) - A copy of the base swagger file extended with a custom `ApiPostgresQueryDatasource`:

```yaml
ApiPostgresQueryDatasource:
  type: object
  description: Postgres datasource that queries time series data from a PostgreSQL table
  required:
    - type
    - connectionString
    - tableName
    - fieldName
    - timestampFieldName
    - fieldMeta
  properties:
    type:
      type: string
      enum: [postgres]
    connectionString:
      type: string
    tableName:
      type: string
    fieldName:
      type: string
    timestampFieldName:
      type: string
    fieldMeta:
      $ref: '#/components/schemas/ApiQueryFieldMeta'
```

### Generated Files

Run `./generate.sh` to generate:

1. **openapi_generated.gen.go** - Generated by oapi-codegen from extended-swagger.yaml
2. **openapi_parser*.go** - Parser files copied and transformed by codegen tool
3. **openapi_parser_test.go** - Comprehensive test suite for all base functionality

### Custom Implementation

- **custom_parser.go** - Implements `PluginApiParser` to handle the Postgres datasource
- **custom_parser_test.go** - Tests for the custom parser implementation

## Running Tests

```bash
# Generate all code
./generate.sh

# Run all tests
go test -v

# Run only custom parser tests
go test -v -run TestCustomPluginParser
```

## How It Works

1. **Extended Spec**: Added Postgres datasource to the discriminator mapping
2. **Code Generation**:
   - oapi-codegen generates Api* structs including `ApiPostgresQueryDatasource`
   - Codegen tool copies parser files and transforms package references
3. **Custom Parser**: Implements only the Postgres-specific parsing logic
4. **Integration**: Base parser delegates unknown types to custom parser via `PluginApiParser` interface

## Key Validations

The tests verify:

✅ Package transformation (queryopenapi → testdata)
✅ Api* struct references work correctly
✅ Custom datasource parsing integrates seamlessly
✅ All base parser functionality continues to work
✅ 44+ comprehensive tests covering all entity types

## Files Not Checked In

The following files are **generated** and should not be committed:
- `openapi_generated.gen.go`
- `openapi_parser.go`
- `openapi_parser_datasource.go`
- `openapi_parser_filter.go`
- `openapi_parser_field.go`
- `openapi_parser_test.go`

Only source files are checked in:
- `extended-swagger.yaml` (spec extension)
- `custom_parser.go` (custom implementation)
- `custom_parser_test.go` (custom tests)
- `generate.sh` (generation script)
- `generate.go` (go:generate directives)
- `go.mod` (module definition)
